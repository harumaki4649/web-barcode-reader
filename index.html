<!DOCTYPE html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ISBN Scanner (Debug)</title>
<style>
body { font-family: sans-serif; margin:0; padding:1em; background:#f5f5f5; }
#viewport { position:relative; width:100%; max-width:480px; margin:auto;
           border: 3px solid #007bff; border-radius:8px; overflow:hidden; }
video { width:100%; height:auto; display:block; }
canvas { position:absolute; top:0; left:0; }
#debug { margin:1em 0; padding:1em; background:#fff; border-radius:8px;
         font-size:12px; max-height:150px; overflow-y:auto; }
#status { margin:0.5em 0; font-weight:bold; color:#007bff; text-align:center; }
#list { margin-top:1em; max-height:200px; overflow-y:auto; }
#list li { padding:8px; margin:4px 0; border-radius:4px; background:#fff; }
.controls { margin:1em 0; text-align:center; }
button { padding:0.8em 1.5em; margin:0 0.5em; border:none; border-radius:6px;
         font-size:14px; font-weight:bold; }
button:enabled { background:#007bff; color:white; cursor:pointer; }
button:disabled { background:#ccc; color:#666; }
.guide { position:absolute; top:30%; left:20%; right:20%; bottom:30%;
         border:2px dashed #00ff00; background:rgba(0,255,0,0.1); }
</style>

<h2>ğŸ“± ISBN Scanner (Debugç‰ˆ)</h2>

<div id="viewport">
  <div class="guide"></div>
</div>
<div id="status">ğŸ“· æº–å‚™ä¸­...</div>

<div class="controls">
  <button id="btn-start">ğŸš€ ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹</button>
  <button id="btn-stop" disabled>â¹ åœæ­¢</button>
  <button id="btn-clear">ğŸ—‘ ã‚¯ãƒªã‚¢</button>
</div>

<div id="debug">
  <strong>ğŸ”§ ãƒ‡ãƒãƒƒã‚°æƒ…å ±:</strong><br>
  <div id="debug-log">å¾…æ©Ÿä¸­...</div>
</div>

<h3>ğŸ“š æ¤œå‡ºçµæœ:</h3>
<ul id="list"></ul>

<script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>
<script>
const viewport = document.getElementById('viewport');
const status = document.getElementById('status');
const debugLog = document.getElementById('debug-log');
const list = document.getElementById('list');
const counts = {};
let isScanning = false;

function log(msg) {
  const time = new Date().toLocaleTimeString();
  debugLog.innerHTML = `[${time}] ${msg}<br>` + debugLog.innerHTML;
  console.log(msg);
}

function render() {
  if (Object.keys(counts).length === 0) {
    list.innerHTML = '<li style="color:#999;">ã¾ã æ¤œå‡ºã•ã‚Œã¦ã„ã¾ã›ã‚“</li>';
    return;
  }
  list.innerHTML = Object.entries(counts)
    .sort(([,a], [,b]) => b - a)
    .map(([code, n]) => `<li>ğŸ“– <strong>${code}</strong> Ã— ${n}</li>`)
    .join('');
}

// é«˜å“è³ªè¨­å®š
const config = {
  inputStream: {
    name: "Live",
    type: "LiveStream",
    target: viewport,
    constraints: {
      facingMode: "environment",
      width: { min: 640, ideal: 1280, max: 1920 },
      height: { min: 480, ideal: 720, max: 1080 }
    },
    area: {    // æ¤œå‡ºã‚¨ãƒªã‚¢ã‚’ä¸­å¤®ã«é™å®š
      top: "30%", right: "20%", left: "20%", bottom: "30%"
    },
    willReadFrequently: true  // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è­¦å‘Šã‚’è§£æ¶ˆ
  },
  frequency: 10,              // æ¤œå‡ºé »åº¦ã‚’ä¸Šã’ã‚‹
  numOfWorkers: 4,            // ãƒãƒ«ãƒã‚¹ãƒ¬ãƒƒãƒ‰
  decoder: {
    readers: [
      "ean_reader",           // EAN-13/8
      "ean_8_reader",         // EAN-8å°‚ç”¨
      "code_128_reader"       // Code128 (å¿µã®ãŸã‚)
    ],
    multiple: false           // æœ€åˆã®1å€‹ã ã‘
  },
  locate: true,
  locator: {
    patchSize: "medium",      // ãƒ‘ãƒƒãƒã‚µã‚¤ã‚ºã‚’ä¸­ç¨‹åº¦ã«
    halfSample: false,        // é«˜å“è³ªãƒ¢ãƒ¼ãƒ‰
    willReadFrequently: true  // Canvasæœ€é©åŒ–
  },
  debug: {
    drawBoundingBox: true,    // å¢ƒç•Œãƒœãƒƒã‚¯ã‚¹è¡¨ç¤º
    showFrequency: true,      // æ¤œå‡ºé »åº¦è¡¨ç¤º
    drawScanline: true,       // ã‚¹ã‚­ãƒ£ãƒ³ãƒ©ã‚¤ãƒ³è¡¨ç¤º
    showPattern: true         // ãƒ‘ã‚¿ãƒ¼ãƒ³è¡¨ç¤º
  }
};

function onProcessed(result) {
  const canvas = Quagga.canvas.dom.overlay;
  const ctx = canvas.getContext('2d', { willReadFrequently: true });

  if (result) {
    // æ¤œå‡ºè©¦è¡Œã‚’ãƒ­ã‚°
    log(`ğŸ“¡ Processing: ${result.codeResult ? 'Found' : 'Searching'}...`);

    if (result.boxes) {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      result.boxes.filter(box => box !== result.box).forEach(box => {
        Quagga.ImageDebug.drawPath(box, {x: 0, y: 1}, ctx, {color: "green", lineWidth: 2});
      });
    }

    if (result.box) {
      Quagga.ImageDebug.drawPath(result.box, {x: 0, y: 1}, ctx, {color: "blue", lineWidth: 2});
    }

    if (result.codeResult && result.codeResult.drawPath) {
      Quagga.ImageDebug.drawPath(result.codeResult.drawPath, {x: 'x', y: 'y'}, ctx, {color: 'red', lineWidth: 3});
    }
  }
}

function onDetected(result) {
  const code = result.codeResult.code;
  const format = result.codeResult.format;

  log(`ğŸ¯ Detected: ${code} (${format})`);

  // ã‚ˆã‚Šå³å¯†ãªISBNåˆ¤å®š
  if (!/^97[89]\d{10}$/.test(code)) {
    log(`âŒ Not ISBN: ${code}`);
    status.textContent = `âŒ ISBNä»¥å¤–: ${code} (${format})`;
    return;
  }

  // å“è³ªãƒã‚§ãƒƒã‚¯
  const confidence = result.codeResult.decodedCodes.reduce((sum, code) => sum + (code.error || 0), 0);
  log(`ğŸ“Š Confidence: ${confidence.toFixed(2)}`);

  counts[code] = (counts[code] || 0) + 1;
  status.textContent = `âœ… ${code} (${counts[code]}å›ç›®)`;

  if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
  render();
}

function onError(err) {
  log(`âŒ Error: ${err.message || err}`);
  status.textContent = `âŒ ã‚¨ãƒ©ãƒ¼: ${err.message || err}`;
}

function startScanning() {
  if (isScanning) return;

  status.textContent = 'ğŸ”§ ã‚«ãƒ¡ãƒ©åˆæœŸåŒ–ä¸­...';
  log('ğŸš€ Starting scanner...');

  Quagga.init(config, err => {
    if (err) {
      onError(err);
      return;
    }

    log('âœ… Camera initialized');
    Quagga.start();
    isScanning = true;

    // ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²
    Quagga.onProcessed(onProcessed);
    Quagga.onDetected(onDetected);

    status.textContent = 'ğŸ” ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’ç·‘ã®æ å†…ã«åˆã‚ã›ã¦ãã ã•ã„';
    log('ğŸ‘€ Scanning started - ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’è¿‘ã¥ã‘ã¦ãã ã•ã„');

    toggleButtons(true);
  });
}

function stopScanning() {
  if (!isScanning) return;

  Quagga.offProcessed(onProcessed);
  Quagga.offDetected(onDetected);
  Quagga.stop();

  isScanning = false;
  status.textContent = 'â¹ ã‚¹ã‚­ãƒ£ãƒ³åœæ­¢';
  log('â¹ Scanner stopped');

  toggleButtons(false);
}

function toggleButtons(scanning) {
  document.getElementById('btn-start').disabled = scanning;
  document.getElementById('btn-stop').disabled = !scanning;
}

// ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²
document.getElementById('btn-start').onclick = startScanning;
document.getElementById('btn-stop').onclick = stopScanning;
document.getElementById('btn-clear').onclick = () => {
  Object.keys(counts).forEach(k => delete counts[k]);
  render();
  debugLog.innerHTML = 'ãƒ­ã‚°ã‚¯ãƒªã‚¢';
  status.textContent = 'ğŸ—‘ ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ';
};

// åˆæœŸè¡¨ç¤º
render();
log('ğŸ“± Scanner ready - ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„');
</script>
