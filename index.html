<!DOCTYPE html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ğŸ“± ISBN Scanner (Mobile)</title>
<style>
body { 
  font-family: sans-serif; margin:0; padding:0.5em; 
  background:#f8f9fa; font-size:14px; 
}

/* ã‚«ãƒ¡ãƒ©ã‚¨ãƒªã‚¢ - ã‚¹ãƒãƒ›ã§é©åˆ‡ãªã‚µã‚¤ã‚ºã« */
#viewport { 
  position:relative; width:100%; max-width:400px; 
  height:250px; margin:auto; border:2px solid #007bff; 
  border-radius:8px; overflow:hidden; background:#000;
}
video { width:100%; height:100%; object-fit:cover; }
canvas { position:absolute; top:0; left:0; }

/* ã‚¬ã‚¤ãƒ‰æ  */
.guide { 
  position:absolute; top:20%; left:15%; right:15%; bottom:20%;
  border:2px dashed #00ff00; background:rgba(0,255,0,0.1);
  pointer-events:none;
}

/* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ */
#status { 
  margin:0.8em 0; padding:0.6em; background:#fff; 
  border-radius:6px; text-align:center; font-weight:bold; 
  color:#007bff; box-shadow:0 2px 4px rgba(0,0,0,0.1);
}

/* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« */
.controls { 
  margin:1em 0; text-align:center; display:flex; 
  flex-wrap:wrap; gap:0.5em; justify-content:center;
}
button { 
  padding:0.7em 1.2em; border:none; border-radius:6px; 
  font-size:13px; font-weight:bold; min-width:80px;
}
button:enabled { background:#007bff; color:white; cursor:pointer; }
button:disabled { background:#ccc; color:#666; }

/* çµæœãƒªã‚¹ãƒˆ */
#results { margin:1em 0; }
#list { 
  max-height:200px; overflow-y:auto; margin:0; padding:0; 
  list-style:none; background:#fff; border-radius:6px;
  box-shadow:0 2px 4px rgba(0,0,0,0.1);
}
#list li { 
  padding:0.8em; border-bottom:1px solid #eee; 
  display:flex; justify-content:space-between; align-items:center;
}
#list li:last-child { border-bottom:none; }

/* ãƒ‡ãƒãƒƒã‚°ã‚¨ãƒªã‚¢ - æŠ˜ã‚ŠãŸãŸã¿å¯èƒ½ */
#debug-section { margin:1em 0; }
#debug-toggle { 
  background:#6c757d; color:white; width:100%; 
  padding:0.6em; border:none; border-radius:6px; cursor:pointer;
}
#debug-content { 
  display:none; margin-top:0.5em; padding:0.8em; 
  background:#fff; border-radius:6px; font-size:11px; 
  max-height:150px; overflow-y:auto; font-family:monospace;
  box-shadow:0 2px 4px rgba(0,0,0,0.1);
}

/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–èª¿æ•´ */
@media (max-width: 480px) {
  body { padding:0.3em; }
  #viewport { height:200px; }
  .controls { gap:0.3em; }
  button { padding:0.6em 1em; font-size:12px; min-width:70px; }
}
</style>

<h2 style="text-align:center; margin:0.5em 0;">ğŸ“š ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒŠãƒ¼</h2>

<div id="viewport">
  <div class="guide"></div>
</div>

<div id="status">ğŸ“· æº–å‚™å®Œäº† - ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„</div>

<div class="controls">
  <button id="btn-start">ğŸš€ é–‹å§‹</button>
  <button id="btn-stop" disabled>â¹ åœæ­¢</button>
  <button id="btn-clear">ğŸ—‘ ã‚¯ãƒªã‚¢</button>
</div>

<div id="results">
  <h3 style="margin:0.5em 0;">ğŸ“– æ¤œå‡ºçµæœ:</h3>
  <ul id="list"></ul>
</div>

<div id="debug-section">
  <button id="debug-toggle">ğŸ”§ ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è¡¨ç¤º</button>
  <div id="debug-content"></div>
</div>

<script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>
<script>
const viewport = document.getElementById('viewport');
const status = document.getElementById('status');
const debugContent = document.getElementById('debug-content');
const list = document.getElementById('list');
const counts = {};
let isScanning = false;

// ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
document.getElementById('debug-toggle').onclick = () => {
  const content = document.getElementById('debug-content');
  const btn = document.getElementById('debug-toggle');
  if (content.style.display === 'none') {
    content.style.display = 'block';
    btn.textContent = 'ğŸ”§ ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’éè¡¨ç¤º';
  } else {
    content.style.display = 'none';
    btn.textContent = 'ğŸ”§ ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è¡¨ç¤º';
  }
};

function log(msg) {
  const time = new Date().toLocaleTimeString();
  debugContent.innerHTML = `[${time}] ${msg}<br>` + debugContent.innerHTML;
  console.log(msg);
}

function render() {
  if (Object.keys(counts).length === 0) {
    list.innerHTML = '<li style="color:#999; justify-content:center;">ã¾ã æ¤œå‡ºã•ã‚Œã¦ã„ã¾ã›ã‚“</li>';
    return;
  }
  list.innerHTML = Object.entries(counts)
    .sort(([,a], [,b]) => b - a)
    .map(([code, n]) => 
      `<li>
        <span>ğŸ“– <strong>${code}</strong></span>
        <span style="background:#007bff; color:white; padding:0.2em 0.5em; border-radius:12px; font-size:11px;">Ã—${n}</span>
       </li>`
    ).join('');
}

// æ”¹è‰¯ã•ã‚ŒãŸè¨­å®š - EAN-13ã«æœ€é©åŒ–
const config = {
  inputStream: { 
    name: "Live", 
    type: "LiveStream", 
    target: viewport,
    constraints: { 
      facingMode: "environment",
      width: { min: 640, ideal: 800, max: 1280 },
      height: { min: 480, ideal: 600, max: 720 }
    },
    area: {  // ç·‘æ ã‚¨ãƒªã‚¢ã«å¯¾å¿œ
      top: "20%", right: "15%", left: "15%", bottom: "20%"
    },
    willReadFrequently: true
  },
  frequency: 8,                 // æ¤œå‡ºé »åº¦ã‚’èª¿æ•´
  numOfWorkers: 2,              // ãƒ¢ãƒã‚¤ãƒ«å‘ã‘ã«è»½é‡åŒ–
  decoder: { 
    readers: [
      "ean_reader",             // EAN-13/EAN-8 (æ•™ç§‘æ›¸ã®ISBN)
      "ean_8_reader"            // EAN-8å°‚ç”¨
    ],
    multiple: false
  },
  locate: true,
  locator: {
    patchSize: "medium",        // æ•™ç§‘æ›¸ã‚µã‚¤ã‚ºã«é©ã—ãŸè¨­å®š
    halfSample: false           // é«˜å“è³ªãƒ¢ãƒ¼ãƒ‰
  },
  debug: {
    drawBoundingBox: true,      // æ¤œå‡ºæ ã‚’è¡¨ç¤º
    showFrequency: false,       // é »åº¦ã¯éè¡¨ç¤ºï¼ˆãƒ¢ãƒã‚¤ãƒ«ç”¨ï¼‰
    drawScanline: true,         // ã‚¹ã‚­ãƒ£ãƒ³ãƒ©ã‚¤ãƒ³è¡¨ç¤º
    showPattern: false          // ãƒ‘ã‚¿ãƒ¼ãƒ³ã¯éè¡¨ç¤ºï¼ˆè»½é‡åŒ–ï¼‰
  }
};

function onProcessed(result) {
  if (result) {
    log(`ğŸ“¡ Processing... ${result.codeResult ? 'âœ… Found' : 'ğŸ” Searching'}`);
  }
}

function onDetected(result) {
  const code = result.codeResult.code;
  const format = result.codeResult.format;
  
  log(`ğŸ¯ Raw detection: ${code} (${format})`);
  
  // EAN-13 å…¨èˆ¬ã‚’å—ã‘å…¥ã‚Œï¼ˆISBNä»¥å¤–ã‚‚å«ã‚€ï¼‰
  if (!/^\d{13}$/.test(code)) {
    log(`âŒ Not 13-digit EAN: ${code}`);
    status.textContent = `âŒ 13æ¡ã§ãªã„: ${code}`;
    return;
  }
  
  // ISBNåˆ¤å®šã¯ç·©ãã™ã‚‹ï¼ˆ978/979ä»¥å¤–ã®EAN-13ã‚‚å—ã‘å…¥ã‚Œã‚‹å ´åˆï¼‰
  const isISBN = /^97[89]\d{10}$/.test(code);
  const prefix = isISBN ? 'ğŸ“– ISBN' : 'ğŸ·ï¸ EAN-13';
  
  log(`âœ… Valid EAN-13: ${code} ${isISBN ? '(ISBN)' : '(General)'}`);
  
  counts[code] = (counts[code] || 0) + 1;
  status.textContent = `âœ… ${prefix}: ${code} (${counts[code]}å›ç›®)`;
  
  // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
  if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
  render();
}

function startScanning() {
  if (isScanning) return;
  
  status.textContent = 'ğŸ”§ ã‚«ãƒ¡ãƒ©ã‚’åˆæœŸåŒ–ä¸­...';
  log('ğŸš€ Scanner starting...');
  
  Quagga.init(config, err => {
    if (err) {
      log(`âŒ Init error: ${err.message || err}`);
      status.textContent = `âŒ ã‚¨ãƒ©ãƒ¼: ${err.message || err}`;
      return;
    }
    
    log('âœ… Camera ready');
    Quagga.start();
    isScanning = true;
    
    // ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²
    Quagga.onProcessed(onProcessed);
    Quagga.onDetected(onDetected);
    
    status.textContent = 'ğŸ” æ•™ç§‘æ›¸ã®ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’ç·‘æ å†…ã«åˆã‚ã›ã¦ãã ã•ã„';
    log('ğŸ‘€ Scanning active - ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’è¿‘ã¥ã‘ã¦ãã ã•ã„');
    
    toggleButtons(true);
  });
}

function stopScanning() {
  if (!isScanning) return;
  
  Quagga.offProcessed(onProcessed);
  Quagga.offDetected(onDetected);
  Quagga.stop();
  
  isScanning = false;
  status.textContent = 'â¹ ã‚¹ã‚­ãƒ£ãƒ³åœæ­¢';
  log('â¹ Scanner stopped');
  
  toggleButtons(false);
}

function toggleButtons(scanning) {
  document.getElementById('btn-start').disabled = scanning;
  document.getElementById('btn-stop').disabled = !scanning;
}

// ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²
document.getElementById('btn-start').onclick = startScanning;
document.getElementById('btn-stop').onclick = stopScanning;
document.getElementById('btn-clear').onclick = () => {
  Object.keys(counts).forEach(k => delete counts[k]);
  render();
  debugContent.innerHTML = '';
  status.textContent = 'ğŸ—‘ ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ';
};

// åˆæœŸè¡¨ç¤º
render();
log('ğŸ“± Mobile scanner ready');
</script>
